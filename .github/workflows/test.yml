name: test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: setup clojure
      uses: DeLaGuardo/setup-clojure@master
      with:
        tools-deps: '1.10.1.510'
    - name: setup dev tools
      run: DEV_TOOLS_REPO_USER=${{ secrets.DEV_TOOLS_REPO_USER }} DEV_TOOLS_REPO_PASS=${{ secrets.DEV_TOOLS_REPO_PASS }} ./ci/scripts/setup-dev-tools.bash
    - name: configure datomic local
      run: |
        mkdir ~/.datomic
        mkdir /tmp/datomic-storage
        echo "{:storage-dir \"/tmp/datomic-storage\"}" > ~/.datomic/dev-local.edn
    - name: run backend tests
      run: clojure -A:ci-test
      working-directory: app/backend/
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    - name: run frontend tests
      run: ./run-tests.sh
      working-directory: app/frontend/
